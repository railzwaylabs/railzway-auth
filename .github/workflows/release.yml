name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 21
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================
      # AUTO BUILD + PUSH DOCKER IMAGE (GHCR)
      # ============================================
      - name: Build and push Docker image
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          VERSION=v${{ steps.semantic.outputs.new_release_version }}

          echo "üîê Logging into GHCR..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

          echo "üê≥ Building Docker image..."
          docker build -t ghcr.io/${{ github.repository }}:$VERSION .

          echo "üì¶ Pushing image to GHCR..."
          docker push ghcr.io/${{ github.repository }}:$VERSION

      # ============================================
      # DISCORD NOTIFICATION
      # ============================================
      - name: Notify Discord
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          RELEASE_NOTES=$(echo '${{ steps.semantic.outputs.new_release_notes }}' | head -c 1000)
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"üöÄ New Release: v${{ steps.semantic.outputs.new_release_version }}\",
                \"description\": \"**Repository:** \`${{ github.repository }}\`\n**Version:** \`v${{ steps.semantic.outputs.new_release_version }}\`\",
                \"color\": 5814518,
                \"fields\": [
                  {
                    \"name\": \"Release Notes\",
                    \"value\": \"${RELEASE_NOTES}\"
                  }
                ],
                \"footer\": {
                  \"text\": \"Railzway Auth\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }" \
            $DISCORD_WEBHOOK
